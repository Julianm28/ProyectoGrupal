
<!DOCTYPE html>
<html lang="es">
<head><meta charset="utf-8"/><title>Escaneo - CCSS</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="CSS/estilos.css"></head>
<body>
  <div id="nav-placeholder"></div>
  <div class="container-compact">
    <div class="card p-4 mt-4">
      <h3 class="page-title">Escanear c贸digo de insumo</h3>

      <div class="mb-3">
        <video id="video" style="width:100%;max-height:360px;border-radius:8px;background:#000"></video>
      </div>

      <div class="mb-3">
        <input id="barcode-manual" class="form-control" placeholder="O escribe/pega c贸digo">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-primary" id="btn-in">Registrar Entrada</button>
        <button class="btn btn-secondary" id="btn-out">Registrar Salida</button>
      </div>

      <div id="scan-result" class="mt-3"></div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    fetch('partials/navbar.html').then(r=>r.text()).then(t=>document.getElementById('nav-placeholder').innerHTML=t);

    
    const video = document.getElementById('video');
    let lastCode = '';

    async function initCamera(){
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
        video.srcObject = stream; video.play();
      } catch (err) { console.warn('No camera access', err); }
    }
    initCamera();

   
    document.getElementById('barcode-manual').addEventListener('change', (e)=> {
      lastCode = e.target.value;
      document.getElementById('scan-result').textContent = 'C贸digo: ' + lastCode;
    });

    async function postMovimiento(tipo){
      const code = lastCode;
      if (!code) return alert('Escanea o escribe un c贸digo primero');
      try {
       
        await apiFetch('/entregas/' + (tipo==='in'?'in':'out'), { method:'POST', body: JSON.stringify({ codigo: code, qty: 1 }) });
        alert('Registrado ' + tipo);
      } catch (err) { alert(err.message || 'Error'); }
    }

    document.getElementById('btn-in').addEventListener('click', ()=>postMovimiento('in'));
    document.getElementById('btn-out').addEventListener('click', ()=>postMovimiento('out'));
  </script>
</body>
</html>
