<!-- FrontEnd/solicitudes.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Solicitudes - CCSS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="CSS/estilos.css">
</head>
<body>
  <div id="nav-placeholder"></div>
  <div class="container-compact">
    <div class="card p-4 mt-4">
      <h3 class="page-title">Crear solicitud</h3>
      <form id="form-solicitud" class="row g-2">
        <div class="col-md-4">
          <select id="sel-hospital" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <select id="sel-insumo" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <input id="s-cantidad" class="form-control" type="number" value="1" min="1">
        </div>
        <div class="col-md-2">
          <select id="s-prioridad" class="form-select">
            <option value="rutinario">Rutinario</option>
            <option value="urgente">Urgente</option>
          </select>
        </div>
        <div class="col-12 mt-2">
          <button class="btn btn-primary">Solicitar</button>
        </div>
      </form>

      <hr>
      <h5>Mis solicitudes recientes</h5>
      <div id="mis-solicitudes"></div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    fetch('partials/navbar.html').then(r=>r.text()).then(t=>document.getElementById('nav-placeholder').innerHTML=t);

    async function cargarSelects() {
      const hospitals = await apiFetch('/hospitales');
      const insumos = await apiFetch('/insumos');
      document.getElementById('sel-hospital').innerHTML = hospitals.map(h=>`<option value="${h._id}">${h.nombre}</option>`).join('');
      document.getElementById('sel-insumo').innerHTML = insumos.map(i=>`<option value="${i._id}">${i.nombre}</option>`).join('');
    }

    document.getElementById('form-solicitud').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const body = {
        hospitalId: document.getElementById('sel-hospital').value,
        insumo: document.getElementById('sel-insumo').value,
        cantidad: Number(document.getElementById('s-cantidad').value),
        prioridad: document.getElementById('s-prioridad').value
      };
      try {
        await apiFetch('/solicitudes', { method:'POST', body: JSON.stringify(body) });
        alert('Solicitud enviada');
        listaMis();
      } catch (err) { alert(err.message || 'Error'); }
    });

    async function listaMis(){
      try {
        const all = await apiFetch('/solicitudes'); // backend debe filtrar por requester en controller.misSolicitudes
        const mine = all.filter(s => s.requesterId === (localStorage.getItem('userId') || '')); // fallback si backend no filtra
        // Si backend ya devuelve solo las del usuario, usa all directamente.
        const arr = (mine.length ? mine : all).map(s=>`<div class="card p-2 mb-2"><b>${s.items[0].supplyName || 'Insumo'}</b> - Cant: ${s.items[0].qty} - Estado: ${s.status || s.estado || 'pendiente'}</div>`).join('');
        document.getElementById('mis-solicitudes').innerHTML = arr || '<div class="text-muted">No hay solicitudes</div>';
      } catch (err) { console.error(err); }
    }

    cargarSelects(); listaMis();
  </script>
</body>
</html>
